<!DOCTYPE HTML>
<html lang="en">
<head>
  <meta charset="utf8">
  <title>Test for page errors</title>
  <script type="text/javascript" src="chrome://mochikit/content/tests/SimpleTest/SimpleTest.js"></script>
  <script type="text/javascript;version=1.8" src="common.js"></script>
  <!-- Any copyright is dedicated to the Public Domain.
     - http://creativecommons.org/publicdomain/zero/1.0/ -->
</head>
<body>
<p>Test for page errors</p>

<script class="testbody" type="text/javascript;version=1.8">
SimpleTest.waitForExplicitFinish();

let stubs = [];

Cu.import("resource://gre/modules/osfile.jsm");
const { prepareMessage } = require("devtools/client/webconsole/new-console-output/utils/messages");
const { pageError: snippets} = require("devtools/client/webconsole/new-console-output/test/fixtures/stub-generators/stub-snippets.js");

function doPageErrors() {
  let container = document.createElement("script");
  snippets.forEach((code) => {
    SimpleTest.expectUncaughtException();
    info("starting code: " + code);
    container = document.createElement("script");
    document.body.appendChild(container);
    container.textContent = code;
    document.body.removeChild(container);
    info("ending code: " + code);
  });
}

function startTest() {
  removeEventListener("load", startTest);

  attachConsole(["PageError"], onAttach);
}

function onAttach(aState, aResponse) {
  onPageError = onPageError.bind(null, aState);
  aState.dbgClient.addListener("pageError", onPageError);
  doPageErrors();
}

let pageErrors = [];

function onPageError(aState, aType, aPacket) {
  let message = prepareMessage(aPacket, {getNextId: () => 1});
  stubs.push(formatStub(message.messageText, aPacket));
  let filePath = OS.Path.join("../../../../devtools/client/webconsole/new-console-output/test/fixtures/stubs", "pageError.js");
  OS.File.writeAtomic(filePath, formatFile(stubs));
}

function formatStub(key, message) {
  let prepared = prepareMessage(message, {getNextId: () => "1"});
  return `
stubConsoleMessages.set("${key}", new ConsoleMessage(${JSON.stringify(prepared, null, "\t")}));
`;
}

function formatFile(stubs) {
  return `/* Any copyright is dedicated to the Public Domain.
  http://creativecommons.org/publicdomain/zero/1.0/ */

"use strict";

/*
 * THIS FILE IS AUTOGENERATED. DO NOT MODIFY BY HAND. RUN TESTS IN FIXTURES/ TO UPDATE.
 */

const {
  MESSAGE_SOURCE,
  MESSAGE_TYPE,
  MESSAGE_LEVEL,
} = require("devtools/client/webconsole/new-console-output/constants");

const { ConsoleMessage } = require("devtools/client/webconsole/new-console-output/types");

let stubConsoleMessages = new Map();
${stubs.join("")}

module.exports = stubConsoleMessages`;
}


addEventListener("load", startTest);
</script>
</body>
</html>
